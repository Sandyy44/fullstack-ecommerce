<div class="profile-container">
  <div class="profile-header">
    <div class="profile-image">
      @if(!user.image?.secure_url) {
      <img src='assets/default-avatar.jpg' alt="Profile Picture" class="avatar">

      }
      @else {
      <img [src]="'http://localhost:5000' + user.image?.secure_url" alt="Profile Picture" class="avatar">

      }
      <button class="edit-image-btn" (click)="editProfilePicture()">
        <i class="fas fa-camera"></i>
      </button>
    </div>
    <h2>{{user.userName || 'User'}}</h2>
    <p class="role-badge" [ngClass]="user.role">{{user.role || 'User'}}</p>
  </div>

  <div class="profile-sections">
    <!-- Personal Information Section -->
    <div class="profile-section">
      <div class="section-header">
        <h3>Personal Information</h3>
        <button class="edit-btn" (click)="editPersonalInfo()">
          <i class="fas fa-edit"></i> Edit
        </button>
      </div>
      <div class="info-grid">
        <div class="info-item">
          <label>Username:</label>
          <span>{{user.userName || 'Not provided'}}</span>
        </div>
        <div class="info-item">
          <label>Email:</label>
          <span>{{user.email || 'Not provided'}}</span>
        </div>
        <div class="info-item">
          <label>Phone:</label>
          <span>{{user.phone || 'Not provided'}}</span>
        </div>
        <div class="info-item">
          <label>Gender:</label>
          <span>{{user.gender || 'Not provided'}}</span>
        </div>
        <div class="info-item">
          <label>Date of Birth:</label>
          <span>{{ user.DOB ? (user.DOB | date:'mediumDate') : 'Not provided' }}</span>
        </div>
        <div class="info-item">
          <label>Age:</label>
          <span>{{ user.DOB ? age : 'Not provided' }}</span>
        </div>
      </div>
    </div>

    <!-- Address Section -->
    <div class="profile-section">
      <div class="section-header">
        <h3>Address Information</h3>
        <button class="edit-btn" (click)="editAddress()">
          <i class="fas fa-edit"></i> Edit
        </button>
      </div>
      <div class="info-grid">
        <div class="info-item full-width">
          <label>Address:</label>
          <span>{{user.address || 'Not provided'}}</span>
        </div>
      </div>
    </div>

    <!-- Security Section -->
    <div class="profile-section">
      <div class="section-header">
        <h3>Security</h3>
      </div>
      <div class="security-actions">
        <button class="action-btn primary" (click)="changePassword()">
          <i class="fas fa-lock"></i> Change Password
        </button>
        <button class="action-btn secondary" (click)="deleteProfilePicture()" *ngIf="user.image?.secure_url">
          <i class="fas fa-trash"></i> Remove Profile Picture
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Personal Info Modal -->
<div class="modal" [class.show]="showPersonalInfoModal" (click)="closeModal($event)">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Edit Personal Information</h3>
      <button class="close-btn" (click)="closePersonalInfoModal()">&times;</button>
    </div>
    <form [formGroup]="personalInfoForm" (ngSubmit)="updatePersonalInfo()">
      <div class="form-group">
        <label>Username:</label>
        <input type="text" formControlName="userName" class="form-control">
      </div>
      <div class="form-group">
        <label>Phone:</label>
        <input type="tel" formControlName="phone" class="form-control">
      </div>
      <div class="form-group">
        <label>Gender:</label>
        <select formControlName="gender" class="form-control">
          <option [value]="user.gender">{{user.gender}}</option>
          @if(user.gender === 'Male') {
          <option value="Female">Female</option>
          }
          @else {
          <option value="Male">Male</option>
          }
        </select>
      </div>
      <div class="form-group">
        <label>Date of Birth:</label>
        <input type="date" formControlName="DOB" class="form-control">
      </div>
      <div class="modal-actions">
        <button type="button" class="btn secondary" (click)="closePersonalInfoModal()">Cancel</button>
        <button type="submit" class="btn primary" [disabled]="!personalInfoForm.valid">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Address Modal -->
<div class="modal" [class.show]="showAddressModal" (click)="closeModal($event)">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Edit Address</h3>
      <button class="close-btn" (click)="closeAddressModal()">&times;</button>
    </div>
    <form [formGroup]="addressForm" (ngSubmit)="updateAddress()">
      <div class="form-group">
        <label>Address:</label>
        <textarea formControlName="address" class="form-control" rows="3"
          placeholder="Enter your full address"></textarea>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn secondary" (click)="closeAddressModal()">Cancel</button>
        <button type="submit" class="btn primary" [disabled]="!addressForm.valid">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<!-- Change Password Modal -->
<div class="modal" [class.show]="showPasswordModal" (click)="closeModal($event)">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Change Password</h3>
      <button class="close-btn" (click)="closePasswordModal()">&times;</button>
    </div>
    <form [formGroup]="passwordForm" (ngSubmit)="updatePassword()">
      <div class="form-group">
        <label>Current Password:</label>
        <input type="password" formControlName="currentPassword" class="form-control">
        @if(passwordForm.get('currentPassword')?.touched && passwordForm.get('currentPassword')?.errors?.['required']) {
        <span class="text-danger">Current password is required.</span>
        }
      </div>
      <div class="form-group">
        <label>New Password:</label>
        <input type="password" formControlName="password" class="form-control">
        @if(passwordForm.get('password')?.touched && passwordForm.get('password')?.errors?.['required']) {
        <span class="text-danger">Password is required.</span>
        }
        @if(passwordForm.get('password')?.touched && passwordForm.get('password')?.errors?.['pattern']) {
        <span class="text-danger">Password must be at least 8 characters long and include at least one uppercase
          letter.</span>
        }
      </div>
      <div class="form-group">
        <label>Confirm New Password:</label>
        <input type="password" formControlName="cPassword" class="form-control">
        @if(passwordForm.get('cPassword')?.touched && passwordForm.get('cPassword')?.errors?.['required']) {
        <span class="text-danger">Confirming password is required.</span>
        }
        @if(passwordForm.get('cPassword')?.touched && passwordForm.get('cPassword')?.value !==
        passwordForm.get('password')?.value) {
        <span class="text-danger">Passwords do not match.</span>
        }
      </div>
      @if(errorMessage) {
      <span class="text-danger">Current password is wrong. Please try Again</span>
      }
      <div class="modal-actions">

        <button type="button" class="btn secondary" (click)="closePasswordModal()">Cancel</button>
        <button type="submit" class="btn primary" [disabled]="!passwordForm.valid">Change Password</button>
      </div>
    </form>
  </div>
</div>